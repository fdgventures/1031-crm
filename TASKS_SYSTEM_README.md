# Система тасков (Tasks System)

## Описание

Система тасков позволяет создавать, редактировать и управлять задачами на всех основных объектах CRM:
- **Profile** (Профили)
- **Tax Account** (Налоговые счета)
- **Transaction** (Транзакции)
- **Exchange** (Обмены)
- **EAT** (EAT)
- **Property** (Недвижимость)

## Возможности

### Основные функции
- ✅ Создание тасков с названием и датой окончания
- ✅ Автоматическое присваивание объекта к таску
- ✅ Статусы: `Pending` (В процессе) и `Completed` (Завершен)
- ✅ Чекбокс для быстрого переключения статуса
- ✅ Редактирование и удаление тасков
- ✅ Добавление заметок к таскам
- ✅ Прикрепление файлов к таскам
- ✅ Назначение тасков юзерам и админам

### Work Queue
На странице **Work Queue** (`/work-queue`) отображается:
- Список всех тасков со всех объектов
- Группировка по типам объектов
- Сортировка по дате окончания
- Фильтры: Все / В процессе / Завершенные
- Визуальные индикаторы просроченных задач
- Прямые ссылки на объекты

## Структура базы данных

### Таблицы

#### 1. `tasks`
Основная таблица с информацией о тасках.

**Поля:**
- `id` - уникальный идентификатор
- `title` - название таска
- `entity_type` - тип объекта (profile, tax_account, transaction, exchange, eat, property)
- `entity_id` - ID объекта
- `status` - статус (pending, completed)
- `due_date` - дата окончания
- `created_by` - кто создал таск
- `created_at` - дата создания
- `updated_at` - дата обновления

#### 2. `task_assignments`
Назначения тасков юзерам и админам.

**Поля:**
- `id` - уникальный идентификатор
- `task_id` - ID таска
- `assignee_type` - тип назначенного (user, admin)
- `assignee_id` - ID юзера или админа
- `created_at` - дата назначения

#### 3. `task_attachments`
Прикрепленные файлы к таскам.

**Поля:**
- `id` - уникальный идентификатор
- `task_id` - ID таска
- `file_path` - путь к файлу в storage
- `file_name` - имя файла
- `file_size` - размер файла
- `file_type` - тип файла
- `uploaded_by` - кто загрузил файл
- `created_at` - дата загрузки

#### 4. `task_notes`
Заметки в тасках.

**Поля:**
- `id` - уникальный идентификатор
- `task_id` - ID таска
- `note_text` - текст заметки
- `created_by` - кто создал заметку
- `created_at` - дата создания
- `updated_at` - дата обновления

### Storage Bucket
- **Bucket name:** `task-attachments`
- **Access:** Приватный (только для авторизованных пользователей)

## Применение SQL миграции

1. Перейдите в папку `supabase/migrations/`
2. Найдите файл `018_create_tasks_system.sql`
3. Примените миграцию в Supabase Dashboard или через CLI:

```bash
supabase db push
```

## Использование

### Создание таска на странице объекта

1. Перейдите на страницу просмотра любого объекта (profile, property и т.д.)
2. Прокрутите вниз до секции "Таски"
3. Нажмите кнопку **"+ Новый таск"**
4. Заполните:
   - Название таска (обязательно)
   - Дата окончания (опционально)
5. Нажмите **"Создать таск"**

### Управление таском

**Переключение статуса:**
- Кликните на чекбокс слева от таска

**Редактирование:**
- Нажмите кнопку **"Редактировать"**
- Измените название и/или дату
- Нажмите **"Сохранить"**

**Удаление:**
- Нажмите кнопку **"Удалить"**
- Подтвердите удаление

**Развернуть детали:**
- Нажмите **"Развернуть"** для просмотра заметок и файлов

### Добавление заметок

1. Разверните таск
2. В секции "Заметки" введите текст в поле
3. Нажмите **"Добавить"**

### Прикрепление файлов

1. Разверните таск
2. В секции "Файлы" выберите файл через input
3. Файл автоматически загрузится в storage

### Работа с Work Queue

1. Перейдите на `/work-queue`
2. Используйте фильтры для отображения нужных тасков
3. Кликайте на названия тасков или "Перейти к объекту →" для навигации
4. Переключайте статусы прямо из Work Queue

## Компоненты

### TaskManager
**Путь:** `src/components/TaskManager/TaskManager.tsx`

**Props:**
- `entityType: TaskEntityType` - тип объекта
- `entityId: number` - ID объекта
- `entityName?: string` - имя объекта (опционально)

**Пример использования:**
```tsx
<TaskManager
  entityType="profile"
  entityId={123}
  entityName="John Doe"
/>
```

## Типы (TypeScript)

**Путь:** `src/types/task.types.ts`

Основные типы:
- `Task` - базовый таск
- `TaskWithDetails` - таск с заметками, файлами и назначениями
- `TaskNote` - заметка
- `TaskAttachment` - прикрепленный файл
- `TaskAssignment` - назначение
- `CreateTaskInput` - данные для создания таска
- `UpdateTaskInput` - данные для обновления таска

## Права доступа (RLS)

### Просмотр
- Все авторизованные пользователи могут просматривать таски

### Создание/Редактирование/Удаление
- Только админы (`workspace_owner`, `platform_super_admin`, `admin`)

## Интеграция на новых страницах

Для добавления тасков на новую страницу:

1. Импортируйте компонент:
```tsx
import { TaskManager } from "@/components/TaskManager";
```

2. Добавьте компонент в JSX:
```tsx
<TaskManager
  entityType="your_entity_type"
  entityId={yourEntityId}
  entityName="Optional Name"
/>
```

3. Убедитесь, что `entity_type` есть в enum таблицы `tasks`

## Будущие улучшения

- [ ] Система приоритетов для тасков
- [ ] Email-уведомления о приближающихся дедлайнах
- [ ] Комментарии в таски (вместо простых заметок)
- [ ] Дополнительные фильтры в Work Queue (по дате, по назначенным)
- [ ] Bulk операции (массовое изменение статуса)
- [ ] Интеграция с календарем
- [ ] История изменений таска

## Поддержка

При возникновении проблем проверьте:
1. Применена ли миграция `018_create_tasks_system.sql`
2. Созданы ли RLS политики
3. Создан ли storage bucket `task-attachments`
4. Есть ли права доступа у текущего пользователя

---

**Версия:** 1.0  
**Дата создания:** Ноябрь 2025

